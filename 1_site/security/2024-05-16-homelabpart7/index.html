<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav ul li a { background-image: none; } .site-nav > ul.nav-category-list > li > button svg { transform: rotate(-90deg); } .site-nav > ul.nav-category-list > li.nav-list-item > ul.nav-list { display: block; } </style> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="icon" href="/assets/favicon.ico" type="image/x-icon"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Part 7 - Malware Analysis Lab Setup | Home</title> <meta name="generator" content="Jekyll v4.3.3" /> <meta property="og:title" content="Part 7 - Malware Analysis Lab Setup" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="a" /> <meta property="og:description" content="a" /> <link rel="canonical" href="https://sigsandor.github.io/security/2024-05-16-homelabpart7/" /> <meta property="og:url" content="https://sigsandor.github.io/security/2024-05-16-homelabpart7/" /> <meta property="og:site_name" content="Home" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2024-05-16T00:00:00-04:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Part 7 - Malware Analysis Lab Setup" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-05-16T00:00:00-04:00","datePublished":"2024-05-16T00:00:00-04:00","description":"a","headline":"Part 7 - Malware Analysis Lab Setup","mainEntityOfPage":{"@type":"WebPage","@id":"https://sigsandor.github.io/security/2024-05-16-homelabpart7/"},"url":"https://sigsandor.github.io/security/2024-05-16-homelabpart7/"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/" class="site-title lh-tight"> Home </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/CHANGELOG.html" class="nav-list-link">Changelog</a></li></ul> <div class="nav-category">Security</div> <ul class="nav-list"><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in Network & Security Home Lab category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/security/2024-05-15-homelabpart1/" class="nav-list-link">Network & Security Home Lab</a><ul class="nav-list"><li class="nav-list-item"><a href="/security/2024-05-16-homelabpart2/" class="nav-list-link">Part 2 - pfSense Setup & Configuration</a></li><li class="nav-list-item"><a href="/security/2024-05-16-homelabpart3/" class="nav-list-link">Part 3 - Parrot Security (Linux setup)</a></li><li class="nav-list-item"><a href="/security/2024-05-16-homelabpart4/" class="nav-list-link">Part 4 - pfSense Firewall configuration</a></li><li class="nav-list-item"><a href="/security/2024-07-04-homelabpart5/" class="nav-list-link">Part 5 - Cyber Range setup</a></li><li class="nav-list-item"><a href="/security/2024-07-15-homelabpart6/" class="nav-list-link">Part 6 - Active Directory Setup</a></li></ul></li><li class="nav-list-item"><a href="/security/2024-5-26-DMARC/" class="nav-list-link">Email Authentication: DMARC</a></li><li class="nav-list-item"><a href="/security/2024-06-18-KQLbasics/" class="nav-list-link">KQL basics</a></li><li class="nav-list-item"><a href="/security/2022-05-19-links/" class="nav-list-link">Useful Cybersecurity links</a></li></ul> <div class="nav-category">Networking</div> <ul class="nav-list"><li class="nav-list-item"><a href="/networking/2024-06-22-NetworkingProtocols/" class="nav-list-link">Networking 101</a></li></ul> <div class="nav-category">Personal</div> <ul class="nav-list"><li class="nav-list-item"><a href="/personal/2020-05-21-dusunre/" class="nav-list-link">Online History</a></li><li class="nav-list-item"><a href="/personal/2024-05-16-explorepics/" class="nav-list-link">Photo collection</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Home" aria-label="Search Home" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://www.linkedin.com/in/alex-barkman-b7b26a186/" class="site-button" > Linkedin </a> </li> <li class="aux-nav-list-item"> <a href="https://github.com/sigSandor" class="site-button" > Github </a> </li> </ul> </nav> </div> <div class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/security/2024-05-15-homelabpart1/">Network & Security Home Lab</a></li> <li class="breadcrumb-nav-list-item"><span>Part 7 - Malware Analysis Lab Setup</span></li> </ol> </nav> <div id="main-content" class="main-content"> <main> <p>a</p> <h2 id="network--security-home-lab"> <a href="#network--security-home-lab" class="anchor-heading" aria-labelledby="network--security-home-lab"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Network &amp; Security Home Lab: </h2> <p><img src="/assets/banner.jpg" alt="banner" width="auto" height="auto" /></p> <h3 id="part-7---malware-analysis-lab-setup"> <a href="#part-7---malware-analysis-lab-setup" class="anchor-heading" aria-labelledby="part-7---malware-analysis-lab-setup"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <span style="color: pink; font-weight: bold;">Part 7 - Malware Analysis Lab Setup</span> </h3> <h6 id="posted-june-2024"> <a href="#posted-june-2024" class="anchor-heading" aria-labelledby="posted-june-2024"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Posted <strong><em>june, 2024</em></strong> </h6> <p>Building a Virtual Security Home Lab: Part 7 - Active Directory Lab Setup - Part 2</p> <p>In the previous module, we installed Windows Server 2019, installed AD Domain Services, configured DHCP and set up a DNS Forwarder. In this module, we will continue building out the AD Lab by completing the Domain Controller setup and adding devices to the AD environment.</p> <h2 id="windows-server-2019-setup"> <a href="#windows-server-2019-setup" class="anchor-heading" aria-labelledby="windows-server-2019-setup"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <span style="color: royalblue; font-weight: bold;">Windows Server 2019 Setup</span> </h2> <h3 id="domain-configuration"> <a href="#domain-configuration" class="anchor-heading" aria-labelledby="domain-configuration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Domain Configuration </h3> <p>Certificate Service Installation</p> <p>Select Manage from the top right corner of Server Manager and then select “Add Roles and Features”.</p> <p>Click Next till you reach the Server Roles page. Enable “Active Directory Certificate Services”.</p> <p>Click on Add Features.</p> <p>Click on Next to continue.</p> <p>Click Next till you reach the Role Services Page. Enable “Certificate Authority”. Click on Next to continue.</p> <p>Click on Install to start the setup.</p> <p>After the installation is complete the server has to be restarted. Open the Start Menu, click on the Power icon and then select Restart.</p> <p>Click on Continue to restart the system.</p> <h3 id="certificate-service-configuration"> <a href="#certificate-service-configuration" class="anchor-heading" aria-labelledby="certificate-service-configuration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Certificate Service Configuration </h3> <p>After the restart once Server Manager loads. Click on the Flag icon on the top right side and select “Configure Active Directory Certificate Services”</p> <p>Click on Next.</p> <p>Enable “Certification Authority” and click on Next.</p> <p>Click on Next.</p> <p>Click on Next.</p> <p>Click on Next till you reach the Confirmation page. Click on Configure to save the changes.</p> <p>Click on Close.</p> <h2 id="user-configuration"> <a href="#user-configuration" class="anchor-heading" aria-labelledby="user-configuration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <span style="color: royalblue; font-weight: bold;">User Configuration</span> </h2> <h3 id="ad-admin-setup"> <a href="#ad-admin-setup" class="anchor-heading" aria-labelledby="ad-admin-setup"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> AD Admin Setup </h3> <p>Open the Start menu click on “Windows Administrative Tools” and then select Active Directory Users and Computers.</p> <p>Right-click on the domain name (in my case ad.lab) in the sidebar. Then select New -&gt; User.</p> <p>Enter the First Name, Last Name and User logon name for the new user. This user will be the Administrator for the Domain Controller.</p> <p>Enter the Password for the user. Uncheck all options leaving “Password never expires”. Click on Next to create the user.</p> <p>Expand the dropdown on the domain name from the sidebar. Click on Users. Then double-click on “Domain Admins”.</p> <p>Go to Members -&gt; Add.</p> <p>Enter the name of the user and check on Check Names.</p> <p>Click on OK.</p> <p>Click on Apply then OK to persist the changes.</p> <p>Open the Start menu and then click on the user logo and then select Sign out.</p> <p>From the login screen select “Other user”. Then enter the login name and password that was configured for your domain administrator.</p> <h3 id="ad-user-1-setup-"> <a href="#ad-user-1-setup-" class="anchor-heading" aria-labelledby="ad-user-1-setup-"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <span style="color: royalblue; font-weight: bold;">AD User 1 Setup </span> </h3> <p>Open the Start menu. Select “Windows Administrative Tools” and then choose Active Directory Users and Computers.</p> <p>Right-click on the domain name from the sidebar. Select New -&gt; User.</p> <p>Enter the details for the user.</p> <p>Give the user a password. Check the “User cannot change password” and “Password never expires” options. Click Next to create a user.</p> <h3 id="ad-user-2-setup"> <a href="#ad-user-2-setup" class="anchor-heading" aria-labelledby="ad-user-2-setup"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <span style="color: royalblue; font-weight: bold;">AD User 2 Setup</span> </h3> <p>Follow the same steps as above to create a second AD User.</p> <p>###<span style="color: royalblue; font-weight: bold;">Making AD Lab Exploitable</span></p> <p>To make the Active Directory Lab vulnerable we need to change some settings. We will use a PowerShell script and change so and Group Policies to achieve the desired result.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>You can skip this section and continue from the “Windows 10 Enterprise VM1 Setup” step if you do not plan to make your Active Directory Lab vulnerable to attacks
</code></pre></div></div> <h3 id="running-vulnerable-ad-script"> <a href="#running-vulnerable-ad-script" class="anchor-heading" aria-labelledby="running-vulnerable-ad-script"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Running Vulnerable AD Script </h3> <p>Right-click on the Start menu and select Windows PowerShell (Admin).</p> <p>Run the following command:</p> <h1 id="allow-execution-of-scripts"> <a href="#allow-execution-of-scripts" class="anchor-heading" aria-labelledby="allow-execution-of-scripts"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Allow Execution of Scripts </h1> <p>Set-ExecutionPolicy -ExecutionPolicy Bypass -Force</p> <h1 id="download-and-execute-script"> <a href="#download-and-execute-script" class="anchor-heading" aria-labelledby="download-and-execute-script"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Download and Execute Script </h1> <p>[System.Net.WebClient]::new().DownloadString(‘https://raw.githubusercontent.com/WaterExecution/vulnerable-AD-plus/master/vulnadplus.ps1’) -replace ‘change.me’, ‘ad.lab’ | Invoke-Expression</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Replace ad.lab with the name you have used for your Active Directory Domain before running the above command.
</code></pre></div></div> <p>The above command constants of the following steps: [System.Net.WebClient]::new().DownloadString(): Downloads the Script -replace: Change string present in the script Invoke-Expression: Execute the Script</p> <p>Once the script reaches the end. It will wait for 30 seconds and then restart the system.</p> <h2 id="group-policy-configuration"> <a href="#group-policy-configuration" class="anchor-heading" aria-labelledby="group-policy-configuration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <span style="color: royalblue; font-weight: bold;">Group Policy Configuration</span> </h2> <p>After the system restarts open the Start menu and click on “Windows Administrative Tools” then choose Group Policy Management.</p> <p>Expand “Forest” and then expand “Domains”.</p> <h3 id="disable-windows-defender-and-firewall"> <a href="#disable-windows-defender-and-firewall" class="anchor-heading" aria-labelledby="disable-windows-defender-and-firewall"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Disable Windows Defender and Firewall </h3> <p>Right-click on the domain name. Select “Create a GPO in the domain and link here”.</p> <p>Give the GPO the name Disable Protections.</p> <p>Expand the domain name. Right-click on “Disable Protections” and choose Edit.</p> <p>This will open the Group Policy Management Editor. From the sidebar go to the following folder: Computer Configuration -&gt; Policies -&gt; Administrative Templates -&gt; Windows Components -&gt; Windows Defender Antivirus.</p> <p>Select “Windows Defender Antivirus”. From the right side select “Turn off Windows Defender Antivirus” and click on Edit policy setting.</p> <p>Set it to Enabled. Click on Apply then OK to save the changes.</p> <p>Double-click on Real-time Protection.</p> <p>Select “Turn off real-time protection” and then click on “Edit policy settings”</p> <p>Set it to Enabled. Click on Apply then OK to save the changes.</p> <p>Expand the sidebar folders to the following: Computer Configuration -&gt; Policies -&gt; Administrative Templates -&gt; Network -&gt; Network Connections -&gt; Windows Defender Firewall -&gt; Domain Profile.</p> <p>Select “Windows Defender Firewall: Protect all network connections”. Click on “Edit policy settings”.</p> <p>Set it to Disabled. Click on Apply then OK to save the changes.</p> <p>Close Group Policy Management Editor. From the sidebar of Group Policy Management right-click on “Disable Protections” and choose “Enforced”.</p> <h3 id="enable-remote-login-for-local-admins"> <a href="#enable-remote-login-for-local-admins" class="anchor-heading" aria-labelledby="enable-remote-login-for-local-admins"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Enable Remote Login for Local Admins </h3> <p>Right-click on the domain name. Select “Create a GPO in the domain and link here”.</p> <p>Give the GPO the name Local Admin Remote Login.</p> <p>Right-click on “Local Admin Remote Login” and choose Edit.</p> <p>Using the sidebar descend into Computer Configuration -&gt; Preferences -&gt; Windows Settings -&gt; Registry. Then, right-click Registry and choose New -&gt; Registry Item.</p> <p>For the Hive field select HKEY_LOCAL_MACHINE. To fill the value in the “Key Path” field click on the … button.</p> <p>In the window that opens up navigate to the following directory: SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System</p> <p>Enter the following for the remaining fields: Value name: LocalAccountTokenFilterPolicy Value type: REG_DWORD Value data: 1</p> <p>Click on Apply then OK. Close Group Policy Management Editor.</p> <h3 id="enable-winrm-server"> <a href="#enable-winrm-server" class="anchor-heading" aria-labelledby="enable-winrm-server"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Enable WinRM Server </h3> <p>Right-click on the domain name. Select “Create a GPO in the domain and link here”.</p> <p>Give the GPO the name Enable WinRM Server.</p> <p>Right-click on “Enable WinRM Server” and choose Edit.</p> <p>Using the sidebar go to the following folder: Computer Configuration -&gt; Policies -&gt; Administrative Templates -&gt; Windows Components -&gt; Windows Remote Management (WinRM) -&gt; WinRM Service.</p> <p>Select “Allow remote server management through WinRM” and then click on “Edit policy settings”.</p> <p>Set the policy to Enabled. In the IPv4 filter field enter *. Click on Apply then OK.</p> <p>Select “Allow Basic authentication” and click on “Edit policy settings”.</p> <p>Set the policy to Enabled. Click on Apply and then OK.</p> <p>Select “Allow unencrypted traffic” and click on “Edit policy settings”.</p> <p>Set the policy to Enabled. Click on Apply then OK.</p> <p>In the sidebar navigate to: Computer Configuration -&gt; Preferences -&gt; Control Panel Settings. Right-click on Services and select New -&gt; Service.</p> <p>Select Startup to Automatic. Use the … button to select the Server name.</p> <p>Select “Windows Remote Management (WS-Management)” and click on Select.</p> <p>For Service action select Start service. Click on Apply then OK.</p> <p>Using the sidebar navigate to the following location: Computer Configuration -&gt; Policies -&gt; Administrative Templates -&gt; Windows Components -&gt; Windows Remote Shell</p> <p>Select “Allow Remote Shell Access” and click on “Edit policy setting”.</p> <p>Set the policy to Enabled. Click on Apply then OK. Close the Group Policy Management Editor.</p> <h3 id="enable-rdp-remote-desktop-protocol"> <a href="#enable-rdp-remote-desktop-protocol" class="anchor-heading" aria-labelledby="enable-rdp-remote-desktop-protocol"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Enable RDP (Remote Desktop Protocol) </h3> <p>Right-click on the domain name. Select “Create a GPO in the domain and link here”.</p> <p>Give the GPO the name Enable RDP.</p> <p>Right-click on “Enable RDP” and select Edit.</p> <p>Using the sidebar navigate to the following folder: Computer Configuration -&gt; Policies -&gt; Administrative Templates -&gt; Windows Components -&gt; Remote Desktop Services -&gt; Remote Desktop Session Host -&gt; Connections.</p> <p>Select “Allow users to connect remotely using Remote Desktop Services” and click on “Edit policy settings”.</p> <p>Set the policy to Enabled. Click on Apply then OK. Close Group Policy Management Editor.</p> <h3 id="enable-rpc-remote-procedure-call"> <a href="#enable-rpc-remote-procedure-call" class="anchor-heading" aria-labelledby="enable-rpc-remote-procedure-call"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Enable RPC (Remote Procedure Call) </h3> <p>Right-click on the domain name. Select “Create a GPO in the domain and link here”.</p> <p>Give the GPO the name Enable RPC.</p> <p>Right-click on “Enable RPC” and select Edit.</p> <p>Using the sidebar navigate to the following folder: Computer Configuration -&gt; Administrative Templates -&gt; System -&gt; Remote Procedure Call.</p> <p>Select “Enable RPC Endpoint Mapper Client Authentication” and click on “Edit policy settings”.</p> <p>Set the policy to Enabled. Click on Apply then OK. Close Group Policy Management Editor.</p> <p>Enforce the Domain Policies</p> <p>Right-click on the Start menu and select Windows PowerShell (Admin).</p> <p>In the terminal enter the following:</p> <p>gpupdate /force</p> <p>Now whenever a new device joins our AD environment the Group Policies that apply to all the devices will automatically be applied to them. With this, we have completed the Domain Controller setup.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>For the rest of the module the DC VM should be left powered on. To use the AD lab DC should be the first VM that is launched.
</code></pre></div></div> <h2 id="windows-10-enterprise-vm1-setup"> <a href="#windows-10-enterprise-vm1-setup" class="anchor-heading" aria-labelledby="windows-10-enterprise-vm1-setup"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <span style="color: royalblue; font-weight: bold;">Windows 10 Enterprise VM1 Setup</span> </h2> <p>Select Windows 10 Enterprise VM1 from the sidebar then click on Start.</p> <h3 id="os-installation"> <a href="#os-installation" class="anchor-heading" aria-labelledby="os-installation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> OS Installation </h3> <p>Click on Next.</p> <p>Click on Install now.</p> <p>Accept the agreement and then click on Next.</p> <p>Select “Custom: Install Windows only (advanced)”.</p> <p>Select Disk 0 and then click on Next.</p> <p>The VM will reboot multiple times during the installation.</p> <p>Select your Region and Keyboard Layout.</p> <p>Click on Skip.</p> <p>Select “Domain join instead”. This will allow us to configure a local account.</p> <p>Enter a username and click on Next.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>You can provide any username in this step but to avoid confusion I would recommend using the First Name of one of the non-admin users that was created in AD. In my case the two AD users are John Doe and Jane Doe. For this VM I have choose John, when i configure the 2nd VM I will use Jane.
</code></pre></div></div> <p>Enter a password and click on Next.</p> <p>This password can be different from the password that was configured in Active Directory.</p> <p>Configure the “Security Questions” for the user. Remember to note down these details in a secure location.</p> <p>Disable all the features that are shown. Then click on Accept.</p> <p>Select Not now.</p> <p>Once on the desktop a prompt to allow internet access should show up click on Yes.</p> <h2 id="guest-additions-installation"> <a href="#guest-additions-installation" class="anchor-heading" aria-labelledby="guest-additions-installation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <span style="color: royalblue; font-weight: bold;">Guest Additions Installation</span> </h2> <p>Similar to the Windows 2019 Server VM we need to install Guest Additions to enable Fullscreen mode. From the VM toolbar select Devices -&gt; Remove disk for virtual drive. This will remove the Windows 10 image.</p> <p>Click on Devices -&gt; Insert Guest Additions CD image.</p> <p>Open File Explorer. Once the disk has loaded from the sidebar select the disk drive. Double-click VBoxWindowsAdditions to start the installer.</p> <p>Click Next.</p> <p>Click Next.</p> <p>Click on Install to start the installation.</p> <p>Select “Reboot now” and then click on Finish. The VM will reboot.</p> <p>Login into the system.</p> <p>From the toolbar select Optical Devices -&gt; Remove disk from virtual drive to remove the Guest Additions image.</p> <p>Use the shortcut Right Ctrl+F to enter Fullscreen mode. Use the same key to exit Fullscreen. The VM should automatically scale to fit the window size. Adding VM1 to Domain</p> <p>Now we can add this device to the AD domain and log in as an AD user.</p> <p>Click on the Search Bar and search for “This PC”. Right-click on it and select Properties.</p> <p>Click on Advanced system settings.</p> <p>Select the “Computer Name” tab and click on Change.</p> <p>In the Computer name field enter a name that can be used to easily identify this VM. In the Member of section select Domain and enter the name of the AD domain (in my case ad.lab). Then click on More.</p> <p>In the “Primary DNS suffix of this computer” field enter the domain name. Click on OK.</p> <p>Click on OK.</p> <p>Now a popup should appear. Enter the login name and password of the Domain Admin and click on OK.</p> <p>The device will be added to the AD environment. Click on OK.</p> <p>The device needs to be rebooted to apply the domain-specific settings. Click on OK to continue.</p> <p>Click on “Restart Now”.</p> <p>Once on the login screen. Click on “Other user”. Enter the login name and password of the AD user that will use this device and press Enter.</p> <p>Now we are logged into the system as the AD user. To confirm this we can open PowerShell and run whoami.</p> <p>Windows 10 Enterprise VM2 Setup</p> <p>Follow the same steps as above to configure the VM for the second user.</p> <h2 id="os-installation-1"> <a href="#os-installation-1" class="anchor-heading" aria-labelledby="os-installation-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <span style="color: royalblue; font-weight: bold;">OS Installation</span> </h2> <p>Use the First Name of the second user that was configured in AD.</p> <h2 id="guest-additions-installation-1"> <a href="#guest-additions-installation-1" class="anchor-heading" aria-labelledby="guest-additions-installation-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <span style="color: royalblue; font-weight: bold;">Guest Additions Installation</span> </h2> <h2 id="adding-vm2-to-domain"> <a href="#adding-vm2-to-domain" class="anchor-heading" aria-labelledby="adding-vm2-to-domain"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <span style="color: royalblue; font-weight: bold;">Adding VM2 to Domain</span> </h2> <p>Login using the AD credentials of the second AD user.</p> <h3 id="appendix"> <a href="#appendix" class="anchor-heading" aria-labelledby="appendix"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Appendix </h3> <p>With this, we have completed the setup of the Active Directory lab. To wrap up, in this module we set up 3 VMs. The 1st VM (Windows Server 2019) was configured to be the Domain Controller and the other 2 VMs (Windows 10 Enterprise) were configured as client devices. Additionally, on the DC VM, we enabled DHCP, set up DNS Forwarder, enabled AD Certificate Services and configured Policies to be applied to all devices that are part of the AD environment.</p> <p>You can delete the Windows Server 2019 ISO file if you do not want to store it for future use. Do not delete the Windows 10 Enterprise ISO just yet as we will require it to setup FlareVM.</p> <h3 id="dns--dhcp-verification"> <a href="#dns--dhcp-verification" class="anchor-heading" aria-labelledby="dns--dhcp-verification"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> DNS &amp; DHCP Verification </h3> <p>To verify that the client VMs are indeed connected to the AD environment you can open DHCP Manager and compare the IP address shown with the IP address that has been assigned to the VM.</p> <p>Similarly, we can use DNS Manager to confirm that new DNS entries have been added for the client devices.</p> <p>Taking VM Snapshots</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Snapshots can be taken with the VM in a running state but sometimes doing so can cause the VM to behave erratically. So I recommend “Powering off” all the VM before taking its Snapshot.
</code></pre></div></div> <p>Select the Windows Server 2019 VM. Click on the “Hamburger menu” and select Snapshots from the dropdown menu.</p> <p>Click on Take from the toolbar.</p> <p>Give the snapshot a descriptive name and click on OK.</p> <p>This will create a new Snapshot from the VM.</p> <p>Select the Windows 10 Enterprise VM1 from the sidebar and follow the above steps to create a Snapshot.</p> <p>Follow the same steps to create Snapshot for Windows 10 Enterprise VM2.</p> <p>Right-click on the hamburger menu and select “Details” to return to the VM configuration page.</p> <h3 id="alternative-ad-setup"> <a href="#alternative-ad-setup" class="anchor-heading" aria-labelledby="alternative-ad-setup"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Alternative AD Setup </h3> <p>Many other features and services can enabled on the DC. Refer to the below links for variations on the installation process.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>How to Setup a Basic Home Lab Running Active Directory - YouTube
How to Build an Active Directory Hacking Lab - YouTube
</code></pre></div></div> <h3 id="hacking-ad-lab"> <a href="#hacking-ad-lab" class="anchor-heading" aria-labelledby="hacking-ad-lab"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Hacking AD Lab </h3> <p>There any numerous attacks that can be performed against an AD environment. Refer to the below links to see some of the commonly used hacks.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hack Your VirtualBox AD Lab
Active Directory Methodology - HackTricks
</code></pre></div></div> <p>In the next module, we will begin the setup of the Malware Analysis Lab.</p> <p><span style="color: royalblue; font-weight: bold;">Part 7 - Malware Analysis Lab Setup</span></p> </main> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
